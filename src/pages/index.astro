---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('posts', ({ data }) => !data.draft);
allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const allTags = [...new Set(allPosts.flatMap(p => p.data.tags))].sort();

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
}
---

<BaseLayout>
  <div class="tags" id="tag-filter">
    <button class="tag active" data-tag="all">All</button>
    {allTags.map(tag => (
      <button class="tag" data-tag={tag}>{tag}</button>
    ))}
  </div>

  <ul class="post-list" id="post-list">
    {allPosts.map(post => (
      <li class="post-item" data-tags={post.data.tags.join(',')}>
        <span class="post-date">{formatDate(post.data.date)}</span>
        <a class="post-title-link" href={`/posts/${post.id}`}>{post.data.title}</a>
      </li>
    ))}
  </ul>
</BaseLayout>

<script>
  const tagButtons = document.querySelectorAll<HTMLButtonElement>('#tag-filter .tag');
  const postItems  = document.querySelectorAll<HTMLLIElement>('#post-list .post-item');

  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const selected = btn.dataset.tag ?? 'all';

      tagButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      let visibleIndex = 0;
      postItems.forEach(item => {
        item.classList.remove('animate-in');

        const show = selected === 'all' || (item.dataset.tags ?? '').split(',').includes(selected);
        item.style.display = show ? '' : 'none';

        if (show) {
          // reflow を挟むことで animation が再トリガーされる
          void item.offsetWidth;
          item.style.animationDelay = `${visibleIndex * 45}ms`;
          item.classList.add('animate-in');
          visibleIndex++;
        }
      });
    });
  });
</script>

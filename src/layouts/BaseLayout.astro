---
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
}

const { title, description = 'Yuta Nakabayashi — design, product, writing' } = Astro.props;
const siteTitle = 'Yuta Nakabayashi';
const pageTitle = title ? `${title} — ${siteTitle}` : siteTitle;
---

<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content={description} />
  <title>{pageTitle}</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <script is:inline>
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = saved || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
  </script>
</head>
<body>
  <!-- フィルムグレイン -->
  <svg class="grain" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
    <filter id="grain-filter" x="0%" y="0%" width="100%" height="100%">
      <feTurbulence type="fractalNoise" baseFrequency="0.75" numOctaves="4" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
    </filter>
    <rect width="100%" height="100%" filter="url(#grain-filter)"/>
  </svg>

  <!-- カスタムカーソル -->
  <div class="cursor" id="cursor" aria-hidden="true"></div>

  <div class="container">
    <header id="site-header">
      <div class="header-inner">
        <a href="/" class="site-name">Yuta Nakabayashi</a>
        <nav>
          <a href="/about">About</a>
          <a href="/now">Now</a>
          <button class="theme-toggle" id="theme-toggle" aria-label="テーマを切り替え">D</button>
        </nav>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <footer>
      <p>© {new Date().getFullYear()} Yuta Nakabayashi</p>
    </footer>
  </div>

  <script>
    // ─── テーマ切り替え ────────────────────────────────
    const toggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    function getTheme() {
      return html.getAttribute('data-theme') as string;
    }
    function setTheme(t: string) {
      html.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      if (toggle) toggle.textContent = t === 'dark' ? 'L' : 'D';
    }
    if (toggle) toggle.textContent = getTheme() === 'dark' ? 'L' : 'D';

    toggle?.addEventListener('click', () => {
      setTheme(getTheme() === 'dark' ? 'light' : 'dark');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'd' || e.key === 'D') {
        const tag = (e.target as HTMLElement).tagName;
        if (tag !== 'INPUT' && tag !== 'TEXTAREA') {
          setTheme(getTheme() === 'dark' ? 'light' : 'dark');
        }
      }
    });

    // ─── カスタムカーソル ──────────────────────────────
    const cursor = document.getElementById('cursor');
    if (cursor && window.matchMedia('(hover: hover) and (pointer: fine)').matches) {
      let cx = -100, cy = -100;

      document.addEventListener('mousemove', (e) => {
        cx = e.clientX;
        cy = e.clientY;
        cursor.style.left = cx + 'px';
        cursor.style.top  = cy + 'px';
      });

      document.addEventListener('mouseleave', () => {
        cursor.style.opacity = '0';
      });
      document.addEventListener('mouseenter', () => {
        cursor.style.opacity = '1';
      });

      document.addEventListener('mouseover', (e) => {
        const el = (e.target as HTMLElement).closest('a, button');
        cursor.classList.toggle('cursor--hover', !!el);
      });
    }

    // ─── スクロール時ヘッダー blur ─────────────────────
    const header = document.getElementById('site-header');
    if (header) {
      const sentinel = document.createElement('div');
      sentinel.style.cssText = 'position:absolute;top:0;left:0;height:1px;width:1px;pointer-events:none;';
      document.body.prepend(sentinel);

      new IntersectionObserver(([entry]) => {
        header.classList.toggle('header--scrolled', !entry.isIntersecting);
      }).observe(sentinel);
    }
  </script>
</body>
</html>
